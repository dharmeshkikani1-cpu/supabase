name: Supabase Promote (Schema-only)

on:
  workflow_dispatch:
    inputs:
      target_env:
        description: "Promote to environment"
        type: choice
        required: true
        options: [stage, prod]

concurrency:
  group: supabase-promote
  cancel-in-progress: false

jobs:
  plan-and-backup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Block data-changing SQL in migrations
        shell: bash
        run: |
          set -euo pipefail
          if ls supabase/migrations/*.sql >/dev/null 2>&1; then
            if grep -RInE '(^|[[:space:]])(insert|update|delete|truncate|copy|merge)[[:space:]]' supabase/migrations; then
              echo "âŒ Data-changing SQL detected in migrations. Pipeline is schema-only."
              exit 1
            fi
          fi

      # ---------- BACKUP + DIFF (STAGE) ----------
      - name: Backup dev + stage schemas
        if: ${{ inputs.target_env == 'stage' }}
        env:
          DEV_DB_URL: ${{ secrets.DEV_DB_URL }}
          STAGE_DB_URL: ${{ secrets.STAGE_DB_URL }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p backups
          : "${DEV_DB_URL:?DEV_DB_URL missing}"
          : "${STAGE_DB_URL:?STAGE_DB_URL missing}"

          supabase db dump --db-url "$DEV_DB_URL"   -f "backups/dev_schema.sql"
          supabase db dump --db-url "$STAGE_DB_URL" -f "backups/stage_schema.sql"

          diff -u backups/stage_schema.sql backups/dev_schema.sql \
            | tee backups/dev_to_stage.diff || true

      - name: Plan migrations (dry-run) -> stage
        if: ${{ inputs.target_env == 'stage' }}
        env:
          STAGE_DB_URL: ${{ secrets.STAGE_DB_URL }}
        shell: bash
        run: |
          set -euo pipefail
          : "${STAGE_DB_URL:?STAGE_DB_URL missing}"
          supabase db push --db-url "$STAGE_DB_URL" --dry-run

      # ---------- BACKUP + DIFF (PROD) ----------
      - name: Backup stage + prod schemas
        if: ${{ inputs.target_env == 'prod' }}
        env:
          STAGE_DB_URL: ${{ secrets.STAGE_DB_URL }}
          PROD_DB_URL: ${{ secrets.PROD_DB_URL }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p backups
          : "${STAGE_DB_URL:?STAGE_DB_URL missing}"
          : "${PROD_DB_URL:?PROD_DB_URL missing}"

          supabase db dump --db-url "$STAGE_DB_URL" -f "backups/stage_schema.sql"
          supabase db dump --db-url "$PROD_DB_URL"  -f "backups/prod_schema.sql"

          diff -u backups/prod_schema.sql backups/stage_schema.sql \
            | tee backups/stage_to_prod.diff || true

      - name: Plan migrations (dry-run) -> prod
        if: ${{ inputs.target_env == 'prod' }}
        env:
          PROD_DB_URL: ${{ secrets.PROD_DB_URL }}
        shell: bash
        run: |
          set -euo pipefail
          : "${PROD_DB_URL:?PROD_DB_URL missing}"
          supabase db push --db-url "$PROD_DB_URL" --dry-run

      - uses: actions/upload-artifact@v4
        with:
          name: supabase-backups-and-diff
          path: backups/

  apply:
    needs: plan-and-backup
    runs-on: ubuntu-latest
    environment: ${{ inputs.target_env }}

    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      # ---------- APPLY (STAGE) ----------
      - name: Apply schema migrations to stage (NO seed)
        if: ${{ inputs.target_env == 'stage' }}
        env:
          STAGE_DB_URL: ${{ secrets.STAGE_DB_URL }}
        shell: bash
        run: |
          set -euo pipefail
          : "${STAGE_DB_URL:?STAGE_DB_URL missing}"
          supabase db push --db-url "$STAGE_DB_URL"

      - name: Deploy Edge Functions to stage
        if: ${{ inputs.target_env == 'stage' }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          STAGE_PROJECT_REF: ${{ secrets.STAGE_PROJECT_REF }}
        shell: bash
        run: |
          set -euo pipefail
          : "${STAGE_PROJECT_REF:?STAGE_PROJECT_REF missing}"
          supabase functions deploy --project-ref "$STAGE_PROJECT_REF"

      # ---------- APPLY (PROD) ----------
      - name: Apply schema migrations to prod (NO seed)
        if: ${{ inputs.target_env == 'prod' }}
        env:
          PROD_DB_URL: ${{ secrets.PROD_DB_URL }}
        shell: bash
        run: |
          set -euo pipefail
          : "${PROD_DB_URL:?PROD_DB_URL missing}"
          supabase db push --db-url "$PROD_DB_URL"

      - name: Deploy Edge Functions to prod
        if: ${{ inputs.target_env == 'prod' }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          PROD_PROJECT_REF: ${{ secrets.PROD_PROJECT_REF }}
        shell: bash
        run: |
          set -euo pipefail
          : "${PROD_PROJECT_REF:?PROD_PROJECT_REF missing}"
          supabase functions deploy --project-ref "$PROD_PROJECT_REF"
