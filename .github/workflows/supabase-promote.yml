name: Supabase Promote (Schema-only)

on:
  workflow_dispatch:
    inputs:
      target_env:
        description: "Promote to environment"
        type: choice
        required: true
        options:
          - stage
          - prod

concurrency:
  group: supabase-promote
  cancel-in-progress: false

jobs:
  plan-and-backup:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Select source/target
        id: vars
        shell: bash
        run: |
          if [ "${{ inputs.target_env }}" = "stage" ]; then
            echo "SRC_NAME=dev" >> $GITHUB_OUTPUT
            echo "TGT_NAME=stage" >> $GITHUB_OUTPUT
            echo "SRC_DB_URL=${{ secrets.DEV_DB_URL }}" >> $GITHUB_OUTPUT
            echo "TGT_DB_URL=${{ secrets.STAGE_DB_URL }}" >> $GITHUB_OUTPUT
            echo "TGT_PROJECT_REF=${{ secrets.STAGE_PROJECT_REF }}" >> $GITHUB_OUTPUT
          else
            echo "SRC_NAME=stage" >> $GITHUB_OUTPUT
            echo "TGT_NAME=prod" >> $GITHUB_OUTPUT
            echo "SRC_DB_URL=${{ secrets.STAGE_DB_URL }}" >> $GITHUB_OUTPUT
            echo "TGT_DB_URL=${{ secrets.PROD_DB_URL }}" >> $GITHUB_OUTPUT
            echo "TGT_PROJECT_REF=${{ secrets.PROD_PROJECT_REF }}" >> $GITHUB_OUTPUT
          fi

      - name: Block data-changing SQL in migrations
        shell: bash
        run: |
          set -e
          if ls supabase/migrations/*.sql >/dev/null 2>&1; then
            if grep -RInE '(^|[[:space:]])(insert|update|delete|truncate|copy)[[:space:]]' supabase/migrations; then
              echo "‚ùå Data-changing SQL detected in migrations. Pipeline is schema-only."
              exit 1
            fi
          fi

      - name: Backup SOURCE + TARGET (schema-only)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        shell: bash
        run: |
          mkdir -p backups
          supabase db dump --db-url "${{ steps.vars.outputs.SRC_DB_URL }}" -f "backups/${{ steps.vars.outputs.SRC_NAME }}_schema.sql"
          supabase db dump --db-url "${{ steps.vars.outputs.TGT_DB_URL }}" -f "backups/${{ steps.vars.outputs.TGT_NAME }}_schema.sql"

      - name: Diff schemas (for review)
        shell: bash
        run: |
          set -e
          diff -u "backups/${{ steps.vars.outputs.TGT_NAME }}_schema.sql" \
                "backups/${{ steps.vars.outputs.SRC_NAME }}_schema.sql" \
            | tee "backups/${{ steps.vars.outputs.SRC_NAME }}_to_${{ steps.vars.outputs.TGT_NAME }}.diff" || true

      - name: Plan migrations (dry-run)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        shell: bash
        run: |
          # Shows which migrations would be applied to target, but does not apply them
          supabase db push --db-url "${{ steps.vars.outputs.TGT_DB_URL }}" --dry-run

      - uses: actions/upload-artifact@v4
        with:
          name: supabase-backups-and-diff
          path: backups/

  apply:
    needs: plan-and-backup
    runs-on: ubuntu-latest
    environment: ${{ inputs.target_env }} # <-- prod approvals happen here if you set required reviewers

    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Select target (again)
        id: vars
        shell: bash
        run: |
          if [ "${{ inputs.target_env }}" = "stage" ]; then
            echo "TGT_DB_URL=${{ secrets.STAGE_DB_URL }}" >> $GITHUB_OUTPUT
            echo "TGT_PROJECT_REF=${{ secrets.STAGE_PROJECT_REF }}" >> $GITHUB_OUTPUT
          else
            echo "TGT_DB_URL=${{ secrets.PROD_DB_URL }}" >> $GITHUB_OUTPUT
            echo "TGT_PROJECT_REF=${{ secrets.PROD_PROJECT_REF }}" >> $GITHUB_OUTPUT
          fi

      - name: Apply schema migrations (NO seed)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        shell: bash
        run: |
          # Applies only migrations tracked in supabase/migrations
          # NOTE: do NOT pass --include-seed (keeps it schema-only)
          supabase db push --db-url "${{ steps.vars.outputs.TGT_DB_URL }}"

      - name: Deploy Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        shell: bash
        run: |
          supabase functions deploy --project-ref "${{ steps.vars.outputs.TGT_PROJECT_REF }}"
